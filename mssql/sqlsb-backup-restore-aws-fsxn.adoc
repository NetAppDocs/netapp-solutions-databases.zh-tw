---
sidebar: sidebar 
permalink: mssql/sqlsb-backup-restore-aws-fsxn.html 
keywords: SQL server, SQL, backup, recover, AWS, aws, sql 
summary:  
---
= TR-4951：AWS FSx ONTAP上的 Microsoft SQL Server 備份與還原
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
本文檔介紹使用SnapCenter在 AWS FSx ONTAP上執行 Microsoft SQL Server 備份和復原所需的步驟。其中包括以下資訊：

* NetApp SnapCenter配置
* SnapCenter備份作業
* FCI 資料庫的備份作業
* 多個資料庫的備份操作
* 還原和復原




== SnapCenter配置

必須執行下列步驟來設定SnapCenter並保護 Microsoft SQL Server 資源。以下各節詳細介紹了以下每個步驟。

. 為 SQL Server 備份和還原使用者設定 sysadmin 憑證。
. 配置儲存設定。提供 Amazon Web Services (AWS) 管理憑證以從SnapCenter存取Amazon FSx ONTAP儲存虛擬機器 (SVM)。
. 為SnapCenter新增 SQL Server 主機。部署並安裝所需的SnapCenter插件。
. 配置策略。定義備份作業類型、保留和可選的快照備份複製。
. 設定和保護 Microsoft SQL Server 資料庫。




== SnapCenter新安裝的使用者介面

設定 SQL Server 備份的憑證並使用 sysadmin 權限還原使用者。

image:sqlsb-aws-001.png["此圖顯示輸入/輸出對話框或表示書面內容"]

NetApp建議使用基於角色的存取控制 (RBAC) 將資料保護和管理功能委託給SnapCenter和視窗主機上的各個使用者。使用者必須具有存取託管資料庫的 SQL Server 的權限。對於多個主機，使用者名稱和密碼在各個主機之間必須相同。此外，為了讓SnapCenter能夠在 SQL Server 主機上部署所需的插件，您必須註冊SnapCenter的網域資訊以驗證您的憑證和主機。

展開以下部分以查看有關如何完成每個步驟的詳細說明。

.新增憑證
[%collapsible%open]
====
前往*設定*，選擇*憑證*，然後按一下(*+*)。

image:sqlsb-aws-002.png["此圖顯示輸入/輸出對話框或表示書面內容"]

新使用者必須擁有 SQL Server 主機的管理員權限。

image:sqlsb-aws-003.png["此圖顯示輸入/輸出對話框或表示書面內容"]

====
.配置儲存
[%collapsible%open]
====
若要在SnapCenter中配置存儲，請完成以下步驟：

. 在SnapCenter UI 中，選擇「儲存系統」。有兩種儲存類型，* ONTAP SVM* 和 * ONTAP Cluster*。預設情況下，儲存類型為* ONTAP SVM*。
. 按一下(*+*)新增儲存系統資訊。
+
image:sqlsb-aws-004.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 提供*FSx ONTAP管理*端點。
+
image:sqlsb-aws-005.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. SVM 現已在SnapCenter中配置。
+
image:sqlsb-aws-006.png["此圖顯示輸入/輸出對話框或表示書面內容"]



====
.為SnapCenter新增 SQL Server 主機
[%collapsible%open]
====
若要新增 SQL Server 主機，請完成下列步驟：

. 在「主機」標籤中，按一下 (*+*) 新增 Microsoft SQL Server 主機。
+
image:sqlsb-aws-007.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 提供遠端主機的完全限定網域名稱 (FQDN) 或 IP 位址。
+

NOTE: 憑證是預設填入的。

. 選擇 Microsoft Windows 和 Microsoft SQL Server 選項，然後提交。
+
image:sqlsb-aws-008.png["此圖顯示輸入/輸出對話框或表示書面內容"]



SQL Server 套件已安裝。

image:sqlsb-aws-009.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 安裝完成後，請前往*資源*標籤以驗證所有 FSx ONTAP iSCSI 磁碟區是否存在。
+
image:sqlsb-aws-010.png["此圖顯示輸入/輸出對話框或表示書面內容"]



====
.配置日誌目錄
[%collapsible%open]
====
若要設定主機日誌目錄，請完成下列步驟：

. 按一下複選框。將開啟一個新分頁。
+
image:sqlsb-aws-011.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 按一下*配置日誌目錄*連結。
+
image:sqlsb-aws-012.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 選擇主機日誌目錄和 FCI 實例日誌目錄的磁碟機。點選“儲存”。對叢集中的第二個節點重複相同的過程。關閉視窗。
+
image:sqlsb-aws-013.png["此圖顯示輸入/輸出對話框或表示書面內容"]



主機現在處於運作狀態。

image:sqlsb-aws-014.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 從「*資源*」標籤中，我們可以看到所有的伺服器和資料庫。
+
image:sqlsb-aws-015.png["此圖顯示輸入/輸出對話框或表示書面內容"]



====


== 配置備份策略

備份策略是一組控制如何管理、排程和保留備份的規則。它有助於根據您公司的 SLA 確定備份類型和頻率。

展開以下部分以查看有關如何完成每個步驟的詳細說明。

.配置 FCI 資料庫的備份操作
[%collapsible%open]
====
若要為 FCI 資料庫設定備份策略，請完成下列步驟：

. 前往*設定*並選擇左上角的*策略*。然後點選“*新建*”。
+
image:sqlsb-aws-016.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 輸入策略名稱和描述。按一下“下一步”。
+
image:sqlsb-aws-017.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 選擇*完整備份*作為備份類型。
+
image:sqlsb-aws-018.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 選擇計劃頻率（基於公司 SLA）。按一下“下一步”。
+
image:sqlsb-aws-019.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 配置備份的保留設定。
+
image:sqlsb-aws-020.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 配置複製選項。
+
image:sqlsb-aws-021.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 指定在備份作業運行之前和之後運行的運行腳本（如果有）。
+
image:sqlsb-aws-022.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 根據備份計劃運行驗證。
+
image:sqlsb-aws-023.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. *摘要*頁面提供了備份策略的詳細資訊。任何錯誤都可以在這裡糾正。
+
image:sqlsb-aws-024.png["此圖顯示輸入/輸出對話框或表示書面內容"]



====


== 配置和保護 MSSQL Server 資料庫

. 設定備份策略的開始日期和到期日期。
+
image:sqlsb-aws-025.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 定義備份計畫。為此，請按一下 (*+*) 來配置時間表。輸入*開始日期*和*到期日*。根據公司的 SLA 設定時間。
+
image:sqlsb-aws-026.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 配置驗證伺服器。從下拉式選單中選擇伺服器。
+
image:sqlsb-aws-027.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 點選加號並確認，確認配置的計畫。
. 提供電子郵件通知的資訊。按一下“下一步”。
+
image:sqlsb-aws-028.png["此圖顯示輸入/輸出對話框或表示書面內容"]



現已配置 SQL Server 資料庫的備份策略摘要。

image:sqlsb-aws-029.png["此圖顯示輸入/輸出對話框或表示書面內容"]



== SnapCenter備份作業

若要建立按需 SQL Server 備份，請完成下列步驟：

. 從*資源*視圖中，選擇資源並選擇*立即備份*。
+
image:sqlsb-aws-030.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 在「*備份*」對話方塊中，按一下「*備份*」。
+
image:sqlsb-aws-031.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 顯示確認畫面。按一下“是”確認。
+
image:sqlsb-aws-032.png["此圖顯示輸入/輸出對話框或表示書面內容"]





== 監視備份作業

. 從「*監控*」標籤中，按一下該作業並選擇右側的「*詳細資料*」以查看該作業。
+
image:sqlsb-aws-033.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
image:sqlsb-aws-034.png["此圖顯示輸入/輸出對話框或表示書面內容"]



備份完成後，拓樸視圖中會顯示一個新條目。



== 多個資料庫的備份操作

若要為多個 SQL Server 資料庫設定備份策略，請透過完成下列步驟建立資源群組原則：

. 在「檢視」功能表的「資源」標籤中，使用下拉式選單變更為資源組。
+
image:sqlsb-aws-035.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 按一下 (*+*) 可取得新的資源群組。
+
image:sqlsb-aws-036.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 提供名稱和標籤。按一下“下一步”。
+
image:sqlsb-aws-037.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 將資源新增至資源組：
+
** *主持人。 *從下拉式選單中選擇託管資料庫的伺服器。
** 資源類型。從下拉式選單中選擇*資料庫*。
** SQL Server 執行個體。選擇伺服器。
+
image:sqlsb-aws-038.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
預設情況下，選擇“自動從相同儲存磁碟區中選擇所有資源”*選項。清除該選項並僅選擇需要新增至資源組的資料庫，按一下箭頭新增並按一下*下一步*。

+
image:sqlsb-aws-039.png["此圖顯示輸入/輸出對話框或表示書面內容"]



. 在策略上，按一下 (*+*)。
+
image:sqlsb-aws-040.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 輸入資源組策略名稱。
+
image:sqlsb-aws-041.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 根據您公司的 SLA 選擇*完整備份*和計劃頻率。
+
image:sqlsb-aws-042.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 配置保留設定。
+
image:sqlsb-aws-043.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 配置複製選項。
+
image:sqlsb-aws-044.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 配置在執行備份之前執行的腳本。按一下“下一步”。
+
image:sqlsb-aws-045.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 確認以下備份計畫的驗證。
+
image:sqlsb-aws-046.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 在「*摘要*」頁面上，驗證訊息，然後按一下「*完成*」。
+
image:sqlsb-aws-047.png["此圖顯示輸入/輸出對話框或表示書面內容"]





== 設定並保護多個 SQL Server 資料庫

. 按一下 (*+*) 符號以配置開始日期和到期日期。
+
image:sqlsb-aws-048.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 設定時間。
+
image:sqlsb-aws-049.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
image:sqlsb-aws-050.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 從「*驗證*」標籤中，選擇伺服器，配置計劃，然後按一下「*下一步*」。
+
image:sqlsb-aws-051.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 配置通知以傳送電子郵件。
+
image:sqlsb-aws-052.png["此圖顯示輸入/輸出對話框或表示書面內容"]



該策略現已配置為備份多個 SQL Server 資料庫。

image:sqlsb-aws-053.png["此圖顯示輸入/輸出對話框或表示書面內容"]



== 觸發多個 SQL Server 資料庫的按需備份

. 從“*資源*”標籤中，選擇視圖。從下拉式選單中選擇“*資源組*”。
+
image:sqlsb-aws-054.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 選擇資源組名稱。
. 點選右上角的*立即備份*。
+
image:sqlsb-aws-055.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 將會開啟一個新視窗。按一下*備份後驗證*複選框，然後按一下備份。
+
image:sqlsb-aws-056.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 顯示確認訊息。按一下“是”。
+
image:sqlsb-aws-057.png["此圖顯示輸入/輸出對話框或表示書面內容"]





== 監控多資料庫備份作業

從左側導覽列中，按一下*監控*，選擇備份作業，然後按一下*詳細資料*查看作業進度。

image:sqlsb-aws-058.png["此圖顯示輸入/輸出對話框或表示書面內容"]

按一下「*資源*」標籤查看完成備份所需的時間。

image:sqlsb-aws-059.png["此圖顯示輸入/輸出對話框或表示書面內容"]



== 多個資料庫備份的交易日誌備份

SnapCenter支援完整、批次日誌和簡單復原模型。簡單復原模式不支援交易日誌備份。

若要執行交易日誌備份，請完成下列步驟：

. 從「*資源*」標籤中，將檢視功能表從「*資料庫*」變更為「*資源組*」。
+
image:sqlsb-aws-060.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 選擇已建立的資源組備份策略。
. 選擇右上角的*修改資源組*。
+
image:sqlsb-aws-061.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. *名稱*部分預設為備份策略名稱和標籤。按一下“下一步”。
+
*資源*標籤突顯了要設定交易備份策略的基礎。

+
image:sqlsb-aws-062.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 輸入策略名稱。
+
image:sqlsb-aws-063.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 選擇 SQL Server 備份選項。
. 選擇日誌備份。
. 根據您公司的 RTO 設定計劃頻率。按一下“下一步”。
+
image:sqlsb-aws-064.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 配置日誌備份保留設定。按一下“下一步”。
+
image:sqlsb-aws-065.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. （可選）配置複製選項。
+
image:sqlsb-aws-066.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. （可選）配置在執行備份作業之前執行的任何腳本。
+
image:sqlsb-aws-067.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. （可選）配置備份驗證。
+
image:sqlsb-aws-068.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 在「*摘要*」頁面上，按一下「*完成*」。
+
image:sqlsb-aws-069.png["此圖顯示輸入/輸出對話框或表示書面內容"]





== 配置和保護多個 MSSQL Server 資料庫

. 按一下新建立的交易日誌備份策略。
+
image:sqlsb-aws-070.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 設定*開始日期*和*到期日*。
. 根據 SLA、RTP 和 RPO 輸入日誌備份策略的頻率。按一下“確定”。
+
image:sqlsb-aws-071.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 您可以看到這兩項政策。按一下“下一步”。
+
image:sqlsb-aws-072.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 配置驗證伺服器。
+
image:sqlsb-aws-073.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 配置電子郵件通知。
+
image:sqlsb-aws-074.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 在「*摘要*」頁面上，按一下「*完成*」。
+
image:sqlsb-aws-075.png["此圖顯示輸入/輸出對話框或表示書面內容"]





== 觸發多個 SQL Server 資料庫的按需交易日誌備份

若要觸發多個 SQL 伺服器資料庫的交易日誌的按需備份，請完成以下步驟：

. 在新策略頁面，選擇頁面右上角的*立即備份*。
+
image:sqlsb-aws-076.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 從*策略*標籤的彈出視窗中，選擇下拉式選單，選擇備份策略，配置交易日誌備份。
+
image:sqlsb-aws-077.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 按一下“*備份*”。將顯示一個新視窗。
. 按一下「*是*」確認備份策略。
+
image:sqlsb-aws-078.png["此圖顯示輸入/輸出對話框或表示書面內容"]





== 監控

移至「*監控*」標籤並監控備份作業的進度。

image:sqlsb-aws-079.png["此圖顯示輸入/輸出對話框或表示書面內容"]



== 還原和復原

請參閱在SnapCenter中還原 SQL Server 資料庫所需的下列先決條件。

* 還原作業完成之前，目標實例必須處於線上狀態並且正在執行。
* 必須停用計劃針對 SQL Server 資料庫執行的SnapCenter操作，包括在遠端管理或遠端驗證伺服器上規劃的任何作業。
* 如果要將自訂日誌目錄備份還原到備用主機，則SnapCenter伺服器和插件主機必須安裝相同的SnapCenter版本。
* 您可以將系統資料庫還原到備用主機。
* SnapCenter可以在不使 SQL Server 叢集群組離線的情況下還原 Windows 叢集中的資料庫。




== 將 SQL Server 資料庫上已刪除的表還原到某個時間點

若要將 SQL Server 資料庫還原到某個時間點，請完成下列步驟：

. 以下螢幕截圖顯示了刪除表之前 SQL Server 資料庫的初始狀態。
+
image:sqlsb-aws-080.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
螢幕截圖顯示表中刪除了 20 行。

+
image:sqlsb-aws-081.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 登入SnapCenter伺服器。從“*資源*”標籤中，選擇資料庫。
+
image:sqlsb-aws-082.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 選擇最近的備份。
. 在右側選擇*恢復*。
+
image:sqlsb-aws-083.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 將顯示一個新視窗。選擇*恢復*選項。
. 將資料庫還原到建立備份的相同主機。按一下“下一步”。
+
image:sqlsb-aws-084.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 對於*復原類型*，選擇*所有日誌備份*。按一下“下一步”。
+
image:sqlsb-aws-085.png["此圖顯示輸入/輸出對話框或表示書面內容"]

+
image:sqlsb-aws-086.png["此圖顯示輸入/輸出對話框或表示書面內容"]



*預恢復選項：*

. 選擇選項*復原期間用同名覆寫資料庫*。按一下“下一步”。
+
image:sqlsb-aws-087.png["此圖顯示輸入/輸出對話框或表示書面內容"]



恢復後選項：*

. 選擇選項*可操作，但無法還原其他交易日誌*。按一下“下一步”。
+
image:sqlsb-aws-088.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 提供電子郵件設定。按一下“下一步”。
+
image:sqlsb-aws-089.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 在「*摘要*」頁面上，按一下「*完成*」。
+
image:sqlsb-aws-090.png["此圖顯示輸入/輸出對話框或表示書面內容"]





== 監控恢復進度

. 在「監控」標籤中，按一下還原作業詳細資料以查看還原作業的進度。
+
image:sqlsb-aws-091.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 恢復作業詳細資料。
+
image:sqlsb-aws-092.png["此圖顯示輸入/輸出對話框或表示書面內容"]

. 傳回 SQL Server 主機 > 資料庫 > 表存在。
+
image:sqlsb-aws-093.png["此圖顯示輸入/輸出對話框或表示書面內容"]





== 在哪裡可以找到更多信息

要了解有關本文檔中描述的信息的更多信息，請查看以下文檔和/或網站：

* https://www.netapp.com/pdf.html?item=/media/12400-tr4714pdf.pdf["TR-4714：使用NetApp SnapCenter 的Microsoft SQL Server 最佳實務指南"^]
+
https://www.netapp.com/pdf.html?item=/media/12400-tr4714pdf.pdf["https://www.netapp.com/pdf.html?item=/media/12400-tr4714pdf.pdf"^]

* https://docs.netapp.com/us-en/snapcenter-45/protect-scsql/concept_requirements_for_restoring_a_database.html["恢復資料庫的要求"^]
+
https://docs.netapp.com/us-en/snapcenter-45/protect-scsql/concept_requirements_for_restoring_a_database.html["https://docs.netapp.com/us-en/snapcenter-45/protect-scsql/concept_requirements_for_restoring_a_database.html"^]

* 了解克隆資料庫的生命週期
+
https://library.netapp.com/ecmdocs/ECMP1217281/html/GUID-4631AFF4-64FE-4190-931E-690FCADA5963.html["https://library.netapp.com/ecmdocs/ECMP1217281/html/GUID-4631AFF4-64FE-4190-931E-690FCADA5963.html"^]


